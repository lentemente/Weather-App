<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Info App</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Fix: Moved tailwind.config script AFTER the Tailwind CSS CDN script
        // to ensure the 'tailwind' object is defined before configuration.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""/>
    <style>
        /* Custom styles for the map container */
        #map {
            height: 550px; /* Increased height for the map to 550px */
            width: 100%;
            border-radius: 0.5rem; /* Rounded corners */
            cursor: default !important; /* Change map cursor to default arrow */
            z-index: 1; /* Ensure map renders above other elements if z-index conflicts */
        }
        /* Override Leaflet's default hand cursor for dragging */
        #map .leaflet-grab {
            cursor: default !important;
        }
        #map .leaflet-dragging .leaflet-grab {
            cursor: default !important;
        }
        #map .leaflet-clickable {
            cursor: pointer !important; /* Keep pointer for interactive elements like markers */
        }
        /* Basic styling for the body and containers */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E7ECEF; /* Updated to new palette */
            display: flex;
            flex-direction: column; /* Stack main container and charts container vertically */
            justify-content: flex-start;
            align-items: center; /* Center horizontally */
            min-height: 100vh;
            padding: 0; /* Removed padding from body to allow containers to span full width */
            box-sizing: border-box;
        }
        .container,
        .chart-panel-container,
        #chartsWrapper { /* Apply common styling to main white blocks */
            background-color: #FFFFFF; /* Kept white for strong contrast */
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%; /* Ensure they take full width within their parent */
            max-width: 1536px; /* Max width equivalent to Tailwind's max-w-screen-2xl */
            margin-left: auto;
            margin-right: auto; /* Center the blocks */
            padding: 1rem; /* Default padding for all main white blocks */
            box-sizing: border-box; /* Include padding in width */
        }

        /* Specific styles for .container (top section) */
        .container {
            display: flex;
            flex-direction: column; /* Always column direction by default */
            gap: 10px; /* Reduced gap */
            margin-bottom: 15px; /* Space between main container and charts panel */
            padding-top: 15px; /* Adjusting top padding for consistency with content */
            padding-bottom: 15px; /* Adjusting bottom padding */
            /* Removed border: 2px solid #274C77; */
        }

        /* Specific styles for chart-panel-container (chart nav and individual chart panels) */
        .chart-panel-container {
            display: flex; /* Flex for buttons/charts inside */
            flex-direction: column;
            gap: 10px; /* Reduced gap */
            margin-top: 15px; /* Reduced margin */
            margin-bottom: 15px; /* Space after chart nav, before chartsWrapper */
        }

        /* Specific styles for chartsWrapper (holds hourly and daily charts side-by-side) */
        #chartsWrapper {
            display: flex;
            flex-direction: column; /* Default to column on small screens */
            gap: 15px; /* Gap between hourly and daily panels */
            margin-top: 0; /* No extra margin here, handled by previous container's margin-bottom */
            margin-bottom: 15px; /* Space after the entire charts wrapper */
            padding-top: 0; /* No extra padding, panels inside have padding */
            padding-bottom: 0;
            box-shadow: none; /* Remove shadow from wrapper, individual panels have it */
            border-radius: 0; /* Remove border-radius from wrapper, individual panels have it */
            background-color: transparent; /* Make wrapper background transparent */
        }


        /* Style for loading indicator */
        .loading-indicator {
            display: none; /* Hidden by default */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9); /* Kept white for clarity */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        /* Styles for weather result cards */
        .weather-card {
            background-color: #E7ECEF; /* Updated to match selected location card */
            padding: 12px; /* Reduced padding */
            border-radius: 0.75rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 5px; /* Adjusted margin */
            border: 2px solid #274C77; /* Added border to match selected location card */
        }
        .weather-card h3 {
            font-weight: 600; /* Semi-bold */
            color: #274C77; /* Updated to new palette (dark blue) */
        }
        .weather-card p {
            color: #274C77; /* Updated to new palette (dark blue for better contrast) */
        }
        /* Styles for individual chart containers within the charts panel */
        .chart-container {
            background-color: #FFFFFF; /* Kept white for charts background */
            padding: 8px; /* Adjusted padding */
            border-radius: 0.75rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-top: 5px; /* Adjusted margin */
            display: none; /* Hidden by default, will be toggled by JS */
            width: 100%; /* Fill the width of its parent */
            border: 2px solid #274C77; /* Added 2px border to chart containers */
        }
        .chart-container canvas {
            display: block; /* Ensures canvas doesn't have extra space below it */
            width: 100%;
            height: 250px; /* Increased height for charts */
        }
        /* Style for chart navigation buttons */
        .chart-nav-button {
            /* Adjusted padding to be symmetrical after setting min-height/min-width */
            @apply px-4 py-2 text-xl font-bold transition-colors duration-200; /* Updated padding to py-2 (8px) and px-4 (16px) */
            background-color: #E7ECEF; /* Updated to new palette (lightest) */
            color: #274C77; /* Updated to new palette (dark blue) */
            border: 2px solid #274C77; /* Added 2px solid border to buttons */
            min-width: 200px; /* Explicit minimum width */
            min-height: 80px; /* Explicit minimum height */
            display: flex; /* Use flexbox to center content vertically and horizontally */
            justify-content: center;
            align-items: center;
            border-radius: 20px; /* Explicitly set border-radius to 20px */
        }
        /* Removed hover background color change */
        .chart-nav-button:hover {
            /* Kept other hover effects if any, only removed background-color */
        }
        .chart-nav-button.active {
            background-color: #A3CEF1; /* Updated to new palette (light blue for active) */
            border-color: #274C77; /* Updated to new palette (dark blue) */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Stronger shadow */
        }
        /* Style for the main chart navigation wrapper to increase gap */
        #mainChartNav {
            gap: 60px; /* Increased gap between buttons to 60px */
        }
        /* Custom tooltip style */
        #chart-tooltip {
            position: absolute;
            background-color: rgba(39, 76, 119, 0.9); /* Updated to new palette (dark blue with opacity) */
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none; /* Allows mouse events to pass through */
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
            z-index: 1001; /* Above other elements */
        }
        /* Responsive adjustments */
        @media (min-width: 768px) {
            /* For desktop, change main container to row layout */
            .container {
                flex-direction: row; /* Side-by-side on larger screens */
                gap: 20px; /* More gap on larger screens */
                padding: 20px; /* Larger internal padding for the top section on desktop */
            }
            /* Make left and right panels within the container take equal width */
            .left-panel {
                flex-grow: 2; /* Map section twice wider */
                /* Reset padding from default p-4 to match new container padding */
                padding: 0; /* Remove internal padding from panels as parent .container has it */
            }
            .right-panel {
                flex-grow: 1; /* Weather info section */
                padding: 0; /* Remove internal padding from panels as parent .container has it */
            }
            /* Specific padding for .chart-panel-container and #chartsWrapper on desktop */
            .chart-panel-container {
                padding: 20px; /* Apply general padding for horizontal and vertical */
            }
            #chartsWrapper {
                padding: 20px 0; /* Keep top/bottom padding, remove left/right */
            }
            /* Charts wrapper to display its children side-by-side */
            #chartsWrapper {
                flex-direction: row;
                gap: 20px; /* Consistent gap */
            }
            /* Individual chart panels inside chartsWrapper */
            #hourlyChartsPanelContainer,
            #dailyHistoryChartsPanelContainer {
                width: calc(50% + 80px); /* Each takes half width of wrapper + 80px (30px + 50px) */
                padding: 15px; /* Keep padding for these nested panels */
                margin-top: 0; /* Remove specific margin as gap handles it */
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Main content container that holds all sections, applies max-width and centering -->
    <div class="container">
        <!-- Left Panel: Date Selection and Map -->
        <div class="left-panel flex flex-col gap-3">
            <!-- Text above map -->
            <p class="text-sm font-medium" style="color: #8B8C89; text-align: center;">Click on map to select a location</p>
            <!-- Map Container -->
            <div id="map" class="shadow-lg"></div>
        </div>

        <!-- Right Panel: Weather Information Display -->
        <div class="right-panel flex flex-col gap-3">
            <h2 class="text-xl font-bold" style="color: #274C77;">Weather Information</h2>

            <!-- City Selection Dropdown -->
            <div class="mb-2">
                <label for="citySelect" class="block text-sm font-medium" style="color: #274C77;">Select Location:</label>
                <select id="citySelect" class="w-full p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" style="border: 2px solid #6096BA;">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- Date Input -->
            <div class="mb-2">
                <label for="weatherDate" class="block text-sm font-medium" style="color: #274C77;">Select Date:</label>
                <input type="date" id="weatherDate" class="w-full p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" style="border: 2px solid #6096BA;">
            </div>

            <!-- Selected Location Display -->
            <div class="mb-2 p-3 rounded-lg shadow-sm" style="background-color: #E7ECEF; border: 2px solid #274C77;">
                <p class="font-medium" style="color: #274C77;">Selected Location:</p>
                <p id="selectedLocation" class="font-bold" style="color: #274C77;">No location selected</p>
                <p class="font-medium mt-1" style="color: #274C77;">Selected Date:</p>
                <p id="selectedDateDisplay" class="font-bold" style="color: #274C77;">No date selected</p>
            </div>

            <!-- Weather Results Display (Daily Summary for selected date) -->
            <div id="weatherResults" class="flex flex-col gap-2">
                <p class="text-center" style="color: #8B8C89;">Click a location on the map and select a date to see weather details.</p>
            </div>

            <!-- Removed note about hourly data delay from here -->

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading-indicator">
                <p class="text-lg font-semibold" style="color: #274C77;">Loading weather data...</p>
            </div>
        </div>
    </div>

    <!-- Main Chart Navigation (unified for both hourly and daily charts) -->
    <div class="chart-panel-container">
        <div class="flex flex-wrap justify-center" id="mainChartNav">
            <button class="chart-nav-button active" data-hourly-chart="temperatureChartContainer" data-daily-chart="dailyTemperatureChartContainer">Temperature</button>
            <button class="chart-nav-button" data-hourly-chart="rainChartContainer" data-daily-chart="dailyRainChartContainer">Rainfall</button>
            <button class="chart-nav-button" data-hourly-chart="snowfallChartContainer" data-daily-chart="dailySnowfallChartContainer">Snowfall</button>
            <button class="chart-nav-button" data-hourly-chart="windGustsChartContainer" data-daily-chart="dailyWindGustsChartContainer">Wind Gusts</button>
        </div>
        <!-- Note about hourly data delay - moved here -->
        <p class="text-sm mt-2 text-center" style="color: #8B8C89;">Note: Weather observations from Open-Meteo.com have a 2-day delay in availability.</p>
    </div>

    <!-- Wrapper for Hourly and Daily Charts to enable side-by-side -->
    <div id="chartsWrapper">
        <!-- Hourly Charts Panel Container -->
        <div id="hourlyChartsPanelContainer" class="chart-panel-container">
            <h3 class="text-xl font-bold text-center mb-1" style="color: #274C77;">Hourly Data Charts</h3>
            <div id="temperatureChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Hourly Temperature (°C)</h4>
                <canvas id="temperatureChart"></canvas>
            </div>
            <div id="rainChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Hourly Rainfall (mm)</h4>
                <canvas id="rainChart"></canvas>
            </div>
            <div id="snowfallChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Hourly Snowfall (cm)</h4>
                <canvas id="snowfallChart"></canvas>
            </div>
            <div id="windGustsChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Hourly Wind Gusts (km/h)</h4>
                <canvas id="windGustsChart"></canvas>
            </div>
        </div>

        <!-- Daily Historical Charts Panel Container -->
        <div id="dailyHistoryChartsPanelContainer" class="chart-panel-container">
            <h3 class="text-xl font-bold text-center mb-1" style="color: #274C77;">30 Day Historical Data Charts</h3>
            <div id="dailyTemperatureChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Daily Temperature (Min/Max, °C)</h4>
                <canvas id="dailyTemperatureChart"></canvas>
                <!-- Removed the specific text describing min/max colors -->
            </div>
            <div id="dailyRainChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Daily Rainfall Sum (mm)</h4>
                <canvas id="dailyRainChart"></canvas>
            </div>
            <div id="dailySnowfallChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Daily Snowfall Sum (cm)</h4>
                <canvas id="snowfallChart"></canvas>
            </div>
            <div id="dailyWindGustsChartContainer" class="chart-container">
                <h4 class="text-md font-semibold mb-1" style="color: #274C77;">Daily Max Wind Gusts (km/h)</h4>
                <canvas id="dailyWindGustsChart"></canvas>
            </div>
        </div>
    </div>


    <!-- The Tooltip div will be created dynamically by JavaScript -->

    <!-- Leaflet JS for the map - IMPORTANT: This MUST load BEFORE our custom script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin=""></script>

    <!-- Our custom script - Placed directly after Leaflet to ensure L is defined -->
    <script>
        // Initialize Firebase variables (provided by the Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        // Corrected the initialization of initialAuthToken to reference __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // Map variables
        let map;
        let marker;
        let selectedLat = null;
        let selectedLon = null;
        let selectedDate = null;
        let selectedAddress = "No address available"; // Stores the reverse geocoded address

        // Predefined city coordinates
        const cities = {
            alexandra: { lat: -45.2096, lon: 169.3871, name: "Alexandra" },
            cromwell: { lat: -45.0392, lon: 169.1979, name: "Cromwell" },
            dunedin: { lat: -45.8788, lon: 170.5028, name: "Dunedin" },
            ettrick: { lat: -45.5900, lon: 169.3620, name: "Ettrick" },
            glenorchy: { lat: -44.8322, lon: 168.3842, name: "Glenorchy" },
            hawea: { lat: -44.6000, lon: 169.2333, name: "Hawea" },
            mosgiel: { lat: -45.875, lon: 170.3486, name: "Mosgiel" },
            outram: { lat: -45.8667, lon: 170.2167, name: "Outram" },
            queenstown: { lat: -45.0312, lon: 168.6626, name: "Queenstown" },
            roxburgh: { lat: -45.5458, lon: 169.3172, name: "Roxburgh" },
            wanaka: { lat: -44.7000, lon: 169.1333, name: "Wanaka" }
        };

        // DOM elements
        const citySelect = document.getElementById('citySelect');
        const weatherDateInput = document.getElementById('weatherDate');
        const selectedLocationDisplay = document.getElementById('selectedLocation');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const weatherResultsDiv = document.getElementById('weatherResults');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Chart Panel elements
        const hourlyChartsPanelContainer = document.getElementById('hourlyChartsPanelContainer');
        const dailyHistoryChartsPanelContainer = document.getElementById('dailyHistoryChartsPanelContainer');
        const mainChartNav = document.getElementById('mainChartNav');


        // Store chart data globally after fetch, so it can be redrawn
        let currentHourlyData = {};
        let currentHourlyUnits = {};
        let currentDailyHistoryData = {}; // Stores 30-day daily data
        let currentDailyHistoryUnits = {}; // Stores 30-day daily units


        // Global store for drawn chart data points for tooltip functionality
        let chartDataPoints = {}; // { 'canvasId': { points: [], dateRanges: [] }, ... }
        let tooltipDiv = null; // Global reference to the tooltip div

        // --- Helper Function for DD/MM/YY Date Formatting ---
        function formatToDDMMYY(dateString) {
            const dateObj = new Date(dateString);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = String(dateObj.getFullYear()).slice(-2); // Get last two digits of the year
            return `${day}/${month}/${year}`;
        }

        // --- Helper Function for DD/MM Date Formatting (for chart X-axis) ---
        function formatToDDMM(dateString) {
            const dateObj = new Date(dateString);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        }

        // --- Tooltip Functions ---
        function createTooltip() {
            tooltipDiv = document.createElement('div');
            tooltipDiv.id = 'chart-tooltip';
            tooltipDiv.style.cssText = `
                position: absolute;
                background-color: rgba(39, 76, 119, 0.9); /* Updated to new palette (dark blue with opacity) */
                color: white;
                padding: 5px 8px;
                border-radius: 4px;
                font-size: 12px;
                pointer-events: none; /* Allows mouse events to pass through */
                opacity: 0;
                transition: opacity 0.1s ease-in-out;
                z-index: 1001; /* Above other elements */
            `;
            document.body.appendChild(tooltipDiv);
        }

        function showTooltip(x, y, content) {
            if (!tooltipDiv) createTooltip();
            tooltipDiv.style.left = `${x + 10}px`; // Offset to the right of cursor
            tooltipDiv.style.top = `${y + 10}px`; // Offset below cursor
            tooltipDiv.innerHTML = content; // Use innerHTML to allow for multiple lines (e.g., min/max temp)
            tooltipDiv.style.opacity = 1;
        }

        function hideTooltip() {
            if (tooltipDiv) {
                tooltipDiv.style.opacity = 0;
            }
        }

        // Helper to get mouse position relative to canvas
        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        // --- Setup Tooltips for all Charts ---
        function setupChartTooltips() {
            // All chart canvas IDs for tooltip handling
            const canvasIds = [
                'temperatureChart', 'rainChart', 'snowfallChart', 'windGustsChart',
                'dailyTemperatureChart', 'dailyRainChart', 'dailySnowfallChart', 'dailyWindGustsChart'
            ];
            canvasIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    canvas.addEventListener('mousemove', (e) => {
                        const mousePos = getMousePos(canvas, e);
                        const points = chartDataPoints[canvas.id] ? chartDataPoints[canvas.id].points : null;

                        if (!points) {
                            hideTooltip();
                            return;
                        }

                        let hoveredPoints = []; // Can be multiple for min/max temp
                        const hitTestTolerance = 5; // Pixels around a point or edge of bar for hit test

                        for (let i = 0; i < points.length; i++) {
                            const p = points[i];
                            if (p === null) continue; // Skip null points

                            // For line charts, check distance to point (circle radius + tolerance)
                            // For bar charts, check if mouse is within bar boundaries
                            if (p.type === 'bar') {
                                if (mousePos.x >= p.x && mousePos.x <= p.x + p.width &&
                                    mousePos.y >= p.y && mousePos.y <= p.y + p.height) {
                                    hoveredPoints.push(p);
                                }
                            } else if (p.type === 'line') {
                                const dist = Math.sqrt(Math.pow(mousePos.x - p.x, 2) + Math.pow(mousePos.y - p.y, 2));
                                if (dist < p.radius + hitTestTolerance) {
                                    hoveredPoints.push(p);
                                }
                            }
                        }

                        if (hoveredPoints.length > 0) {
                            let tooltipContent = '';
                            // Sort by time to ensure consistent display order for multiple points
                            hoveredPoints.sort((a, b) => new Date(a.time).getTime() - new Date(b.time).getTime());

                            // Get display date/time once
                            const firstPoint = hoveredPoints[0];
                            let displayDateTime;
                            if (canvas.id.startsWith('daily')) {
                                // Use the helper function for daily chart tooltips
                                displayDateTime = formatToDDMM(firstPoint.time); // Changed to DD/MM
                            } else {
                                displayDateTime = new Date(firstPoint.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            }
                            tooltipContent += `<strong>${displayDateTime}</strong><br>`;

                            hoveredPoints.forEach(p => {
                                let unit = '';
                                let valueLabel = '';

                                // Determine unit and specific label for min/max temp
                                switch(p.dataKey) {
                                    case 'temperature_2m': unit = currentHourlyUnits.temperature_2m; valueLabel = ''; break;
                                    case 'rain': unit = currentHourlyUnits.rain; valueLabel = ''; break;
                                    case 'snowfall': unit = currentHourlyUnits.snowfall; break;
                                    case 'wind_gusts_10m': unit = currentHourlyUnits.wind_gusts_10m; break;
                                    case 'temperature_2m_max': unit = currentDailyHistoryUnits.temperature_2m_max; valueLabel = 'Max Temp: '; break;
                                    case 'temperature_2m_min': unit = currentDailyHistoryUnits.temperature_2m_min; valueLabel = 'Min Temp: '; break;
                                    case 'rain_sum': unit = currentDailyHistoryUnits.rain_sum; break;
                                    case 'snowfall_sum': unit = currentDailyHistoryUnits.snowfall_sum; break;
                                    case 'wind_gusts_10m_max': unit = currentDailyHistoryUnits.wind_gusts_10m_max; break;
                                }

                                tooltipContent += `${valueLabel}${p.value != null ? p.value.toFixed(1) : 'N/A'} ${unit}<br>`;
                            });

                            showTooltip(e.clientX, e.clientY, tooltipContent);
                        } else {
                            hideTooltip();
                        }
                    });

                    canvas.addEventListener('mouseout', hideTooltip);
                }
            });
        }


        // --- Reverse Geocoding Function ---
        async function getStreetAddress(lat, lon) {
            const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=18&addressdetails=1`;
            try {
                const response = await fetch(nominatimUrl, {
                    headers: {
                        // Nominatim requests a custom User-Agent
                        'User-Agent': 'WeatherApp/1.0 (your-email@example.com)' // Replace with actual app name and email
                    }
                });
                if (!response.ok) {
                    throw new Error(`Nominatim HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Nominatim response:", data);
                if (data.display_name) {
                    return data.display_name;
                } else {
                    // Use toFixed(2) only for display when address is not found
                    return `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)} (Address not found)`;
                }
            } catch (error) {
                console.error("Error fetching address from Nominatim:", error);
                // Use toFixed(2) only for display when lookup fails
                return `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)} (Lookup failed)`;
            }
        }


        // --- Map Initialization ---
        function initMap() {
            // Set up the map with a default view (e.g., Dunedin, NZ)
            map = L.map('map');

            // Use CartoDB Positron for a muted greyscale style without API key requirement
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Add a click listener to the map
            map.on('click', onMapClick);

            // Set initial location to Dunedin
            selectCity('dunedin');
        }

        // Function to handle location selection (from map click or dropdown)
        async function handleLocationSelection(lat, lon, name = null) {
            selectedLat = lat;
            selectedLon = lon;

            // Get the street address only if name is not provided (meaning it's a map click)
            selectedAddress = name || await getStreetAddress(selectedLat, selectedLon);

            // Remove existing marker if any
            if (marker) {
                map.removeLayer(marker);
            }

            // Add a new marker at the selected location
            marker = L.marker([selectedLat, selectedLon]).addTo(map)
                .bindPopup(`Selected Location:<br>${selectedAddress}`)
                .openPopup();

            // Set map view to the selected location
            map.setView([selectedLat, selectedLon], 9);

            // Update the display in the right panel
            selectedLocationDisplay.textContent = selectedAddre
